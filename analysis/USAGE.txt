CMPE492 Analysis Module Usage Guide
====================================

This folder contains all analysis tools for CEX vs DEX market microstructure research.

ğŸ“ Files Overview
-----------------
- symbol_mapper.py      : Symbol format conversion (WETHâ†’eth, WBTCâ†’btc) â­
- correlation.py        : Lead-lag analysis, Granger causality tests
- deviation_calculator.py: Price deviation and arbitrage detection
- slippage.py          : DEX slippage analysis (theoretical vs actual)
- volume_analysis.py   : Volume distribution across exchanges/protocols
- reporting.py         : Data quality reports and statistics
- run_analysis.py      : Main executable script (USE THIS!)


ğŸš€ Quick Start
--------------

1. Setup database first:
   cd ../database
   ./start-db.sh

2. Install analysis dependencies:
   cd ../analysis
   pip install -e .
   # or with uv:
   uv pip install -e .

3. Run analysis:
   python run_analysis.py quality           # Check data coverage
   python run_analysis.py volume            # Volume distribution
   python run_analysis.py statistics        # Basic stats
   python run_analysis.py correlation       # Lead-lag correlation
   python run_analysis.py all              # Run everything


ğŸ“Š Analysis Types
-----------------

1. DATA QUALITY CHECK
   Command: python run_analysis.py quality
   
   What it does:
   - Shows CEX/DEX data coverage
   - Counts records and symbols
   - Reports time ranges
   
   Use when: Starting analysis, verifying data collection

2. VOLUME DISTRIBUTION
   Command: python run_analysis.py volume --symbol BTC/USDT --hours 24
   
   What it does:
   - CEX vs DEX volume breakdown
   - Volume by exchange/chain/protocol
   - Market concentration (Herfindahl index)
   
   Use when: Understanding market structure, comparing venues

3. PRICE DEVIATION ANALYSIS
   Command: python run_analysis.py deviation --pool 0x88e6... --hours 24
   
   What it does:
   - Matches DEX swaps with CEX prices
   - Calculates price deviations
   - Identifies arbitrage opportunities
   
   Use when: Detecting arbitrage, analyzing price efficiency
   Note: Requires pool address (get from database)

4. LEAD-LAG CORRELATION
   Command: python run_analysis.py correlation --symbol BTC/USDT --hours 24
   
   What it does:
   - Computes CEX-DEX correlation
   - Cross-correlation function (lead-lag detection)
   - Granger causality test
   - Volatility comparison
   
   Use when: Understanding price discovery, who leads whom

5. STATISTICS REPORT
   Command: python run_analysis.py statistics --symbol BTC/USDT
   
   What it does:
   - Basic price statistics
   - Top pools by volume
   - Exchange rankings
   
   Use when: Overview of market activity


ğŸ”§ Usage Examples
-----------------

# Check if data is available
python run_analysis.py quality

# Analyze BTC volume distribution over 7 days
python run_analysis.py volume --symbol BTC/USDT --hours 168

# Correlations for ETH over 24h
python run_analysis.py correlation --symbol ETH/USDT --hours 24

# Full analysis suite
python run_analysis.py all --symbol BTC/USDT --hours 24


ğŸ“ Programmatic Usage (In Your Code)
------------------------------------

from analysis import (
    PriceDeviationCalculator,
    LeadLagAnalyzer,
    VolumeAnalyzer,
    SymbolMapper
)

# Symbol mapping (handles format conversion)
mapper = SymbolMapper()

# DEX tokens â†’ CEX format
print(mapper.normalize_token_symbol('WETH'))   # â†’ 'eth'
print(mapper.normalize_token_symbol('WBTC'))   # â†’ 'btc'
print(mapper.normalize_token_symbol('BTCB'))   # â†’ 'btc'
print(mapper.normalize_token_symbol('WBNB'))   # â†’ 'bnb'

# Pool tokens â†’ price_index symbol
symbol = mapper.match_pool_to_price_index('WETH', 'USDT')  # â†’ 'ethusdt'

# Price deviation
calculator = PriceDeviationCalculator()
stats = calculator.analyze_pool(pool_address, hours=24)
print(f"Mean deviation: {stats.mean_deviation:.2f}%")
calculator.close()

# Volume distribution
analyzer = VolumeAnalyzer()
dist = analyzer.analyze_volume_distribution("BTC/USDT", hours=24)
print(f"CEX: {dist.cex_percentage:.1f}%, DEX: {dist.dex_percentage:.1f}%")
analyzer.close()

# Lead-lag correlation
correlation = LeadLagAnalyzer()
result = correlation.analyze_symbol("ETH/USDT", hours=24)
print(f"Correlation: {result.cex_dex_correlation:.3f}")
print(f"Lead/Lag: {result.lead_lag_seconds:.2f}s")
correlation.close()


ğŸ“¦ Dependencies
---------------
numpy>=1.24.0          : Numerical computations
psycopg2-binary>=2.9.0 : Database client
python-dotenv>=0.19.0  : Environment variables
statsmodels>=0.14.0    : Granger causality, time series
scipy>=1.10.0          : Scientific functions
pandas>=2.0.0          : Data manipulation


âš ï¸ Common Issues
----------------

1. "No data available"
   â†’ Check database is running and has data
   â†’ Run: python run_analysis.py quality

2. "Module not found: statsmodels"
   â†’ Install: pip install statsmodels

3. "Database connection failed"
   â†’ Start database: cd ../database && ./start-db.sh

4. "No matched data for pool"
   â†’ Verify pool address exists in database
   â†’ Check time range has activity

5. "Symbol format mismatch"
   â†’ Analysis uses SymbolMapper to handle conversion:
   â†’ price_index table: "btcusdt" (lowercase, no delimiter)
   â†’ dex_swaps + tokens: "WBTC", "WETH" (uppercase)
   â†’ Mapping: WETHâ†’eth, WBTC/BTCBâ†’btc, WBNBâ†’bnb


ğŸ¯ Research Objectives Mapping
-------------------------------

From midterm report â†’ Analysis tool:

1. Price Discovery (P1)
   â†’ correlation.py (lead-lag, Granger causality)

2. Volume Distribution (P2)
   â†’ volume_analysis.py (CEX/DEX breakdown)

3. Liquidity Structure (P3)
   â†’ reporting.py (pool statistics)
   â†’ slippage.py (execution quality)

4. Execution Cost & Slippage (P4)
   â†’ slippage.py (theoretical vs actual)
   â†’ deviation_calculator.py (arbitrage costs)


ğŸ“ˆ Next Steps for Research
---------------------------

After collecting sufficient data:

1. Run quality check to verify data coverage
2. Generate volume distribution reports
3. Analyze price deviations (arbitrage opportunities)
4. Compute lead-lag correlations
5. Generate visualizations (separate dashboard)
6. Write findings in LaTeX report


ğŸ’¡ Tips
-------

- Start with short time periods (--hours 1) for testing
- Use --symbol BTC/USDT or ETH/USDT (most liquid)
- Check data quality first before running other analyses
- Results are stored in database for later retrieval
- Each analyzer has .close() method - always call it
- Symbol formats are auto-converted: WETHâ†’eth, WBTC/BTCBâ†’btc
- Pool token order doesn't matter (WETH/USDT = USDT/WETH)


ğŸ”„ Symbol Format Conversion
----------------------------

The analysis module handles three different symbol formats:

1. CEX Format (price_index table):
   - Lowercase, no delimiter: "btcusdt", "ethusdt", "bnbusdt"

2. DEX Format (tokens table):
   - Uppercase: "WBTC", "WETH", "WBNB", "BTCB"
   - Includes wrapped versions

3. Display Format (user-facing):
   - With slash: "BTC/USDT", "ETH/USDT", "BNB/USDT"

Automatic Mappings:
- WETH, ETH â†’ eth
- WBTC, BTCB, BTC â†’ btc
- WBNB, BNB â†’ bnb
- USDT â†’ usdt

Example:
  DEX Pool: WBTC/USDT
  â†’ Normalized: btcusdt
  â†’ Query: SELECT * FROM price_index WHERE symbol = 'btcusdt'

